---
typora-copy-images-to: ./assets
typora-root-url: ./assets
---

##功能总览

### 联机

| **序号** | **业务功能**                       | **序号** | **业务功能**                   |
| -------- | ---------------------------------- | -------- | ------------------------------ |
| 1        | 产品工厂                           | 17       | 利率计划                       |
| 2        | 业务参数模型                       | 18       | 客户自定义限额管理             |
| 3        | 卡账关系管理                       | 19       | 属性设置/联机属性刷新          |
| 4        | 开户                               | 20       | 账户形态管理                   |
| 5        | 存入/支取/结售汇                   | 21       | 账户协议透支                   |
| 6        | 一对一转账/多借多贷/多个一对一转账 | 22       | 约定转账/约定转存定期          |
| 7        | 销户                               | 23       | 关联保护/保护次序调整          |
| 8        | 定期存入/定期支取                  | 24       | 存折登折相关                   |
| 9        | 冻结/续冻/解冻/扣划                | 25       | 电子账户绑卡/账户手机号验证    |
| 10       | 待支取利息提取                     | 26       | 产品利息试算/产品利率试算      |
| 11       | 存放同业                           | 27       | 活期销户试算/定期支取试算      |
| 12       | 倒起息/利息手工调整                | 28       | 目标存款/智能存款/到期计划支取 |
| 13       | 定期到期后手工转存                 | 29       | 支票相关                       |
| 14       | 账户维护/续存设置/转存指令         | 30       | 集团账单管理                   |
| 15       | 联名账户                           | 31       | 交易对账                       |
| 16       | 利率维护                           | 32       | 各类信息查询                   |

### 批量

| **序号** | **日终批量**                | **序号** | **日终批量**       |
| -------- | --------------------------- | -------- | ------------------ |
| 1        | 到期自动解冻                | 16       | 定期按计划支取     |
| 2        | 存款计息/透支计息           | 17       | 定期按计划存入     |
| 3        | 存款利率重定价              | 18       | 久悬户自动销户     |
| 4        | 透支重定价                  | 19       | 存款报表           |
| 5        | 存款结息                    | 20       | 预付卡到期自动销户 |
| 6        | 透支结息                    | 21       | 应计利息总分核对   |
| 7        | 批量收费                    |          |                    |
| 8        | 存款计提数据汇总            |          | **定时任务**       |
| 9        | 存款上日余额数据汇总        | 1        | 约定转账           |
| 10       | 活期转智能存款              | 2        | 约定开定期         |
| 11       | 定期到期续存/定期到期转逾期 | 3        | 集团账单生成       |
| 12       | 正常户转不动户              | 4        | 文件一对一转账     |
| 13       | 不动户转久悬户              | 5        | 文件冻结解冻       |
| 14       | 久悬户自动销户              |          |                    |
| 15       | 双零余额账户自动销户        |          |                    |

## 参数

### 1. 产品基础属性

**表**

| 表名                 | 中文名                               |
| -------------------- | ------------------------------------ |
| dpf_base             | 产品基础属性                         |
| dpf_open             | 产品开户控制（开户时用，不落地）     |
| dpf_save             | 产品存入控制                         |
| dpf_draw             | 产品支取控制                         |
| dpf_interest         | 产品计息定义                         |
| dpf_pay_inst_plan    | 产品付息计划（不规则周期付息）       |
| dpf_td_draw_interest | 定期支取计息定义(不落地到账户层)     |
| dpf_form_move        | 活期产品形态转移定义(不落地到账户层) |
| dpf_batch_fee        | 产品批量收费定义                     |

**维护接口**

| flowtrans | desc             |
| --------- | ---------------- |
| 4900      | 负债产品参数查询 |
| 4950      | 负债产品参数维护 |
| 4901      | 负债产品模糊查询 |
| 4960      | 负债产品复制     |
| 4963      | 负债产品新增     |

### 2.业务参数模型

**表**

| 账户类型相关          |                        |
| --------------------- | ---------------------- |
| dpp_account_type      | 账户类型定义           |
| dpp_account_prod      | 账户类型关联产品控制   |
| dpp_account_voucher   | 账户类型关联凭证控制   |
| dpp_subacct_voucher   | 子账户类型关联凭证控制 |
| dpp_account_condition | 账户类型支取条件控制   |

| 冻结相关 |      |
| -------- | ---- |
| dpp_froze_type         | 冻结类型定义         |
| dpp_froze_mutex        | 冻结类型互斥         |
| dpp_froze_channel      | 冻结渠道控制         |
| dpp_froze_spec_channel | 冻结特定渠道控制     |

| 透支相关           |              |
| ------------------ | ------------ |
| dpp_overdraft_type | 透支类型定义 |

**维护接口**

| flowtrans        | desc         |
| ---------------- | ------------ |
| **账户类型相关** |              |
| 4952             | 账户类型维护 |
| 4961             | 账户类型新增 |
| **冻结相关**     |              |
| 4953             | 冻结类型维护 |
| 4962             | 冻结类型新增 |

### 3.技术参数

**表**

| 表名                  |                |
| --------------------- | -------------- |
| dpp_condition_feature | 支取条件定义   |
| dpp_froze_trxn        | 冻结交易码控制 |

## 业务

### 1.开户

**结构模型**：产品工厂 + 账户类型相关 --> 子户/账户/卡

<img src="/image-20200427161153031.png" alt="image-20200427161153031" style="zoom:50%;" />

**接口**

| flowtrans | desc         |
| --------- | ------------ |
| 4000      | 活期开户     |
| 4001      | 定期开户     |
| 4002      | 同业活期开户 |
| 4003      | 同业定期开户 |
| 4004      | 新开账户     |

### 2.存入/支取/结售汇

**接口**

| flowtrans | desc             |
| --------- | ---------------- |
| 4020      | 一对一转账       |
| 4021      | 多对多转账       |
| 4022      | 多个一对一转账   |
| 4023      | 外币现金兑换     |
| 4040      | 定期存入         |
| 4041      | 定期支取         |
| 4042      | 同业定期支取     |
| 4052      | 定期到期手工转存 |

### 3.销户

**接口**

| flowtrans | desc     |
| --------- | -------- |
| 4011      | 活期销户 |
| ....      |          |

### 4.冻结解冻

**表**

| 表名 | desc |
| ---- | ---- |
|      |      |

**接口**

| flowtrans | desc               |
| --------- | ------------------ |
| 4030      | 冻结止付           |
| 4031      | 续冻               |
| 4032      | 解冻解止           |
| 4033      | 法院扣划           |
| 4495      | 冻结分类码列表查询 |
| 4496      | 冻结分类码信息查询 |

### 5.利息

**接口**

| flowtrans | desc             |
| --------- | ---------------- |
| 4050      | 待支取利息支取   |
| 4051      | 账户利息调整     |
| 4449      | 账户利率计划查询 |
| 4450      | 账户利率查询     |
| 4451      | 账户应计利息查询 |
| 4452      | 产品利息试算     |
| 4453      | 活期销户利息试算 |
| 4454      | 定期支取利息试算 |
| 4455      | 账户付息信息查询 |

### 6.账户维护

**接口**

| flowtran | desc             |
| -------- | ---------------- |
| 4200     | 账户信息维护     |
| 4220     | 账户利率维护     |
| 4221     | 账户利率计划维护 |

### 7.账户相关查询

**接口**

| flowtran | desc             |
| -------- | ---------------- |
| 4400     | 账户详情查询     |
| 4401     | 账户列表查询     |
| 4402     | 子账户信息查询   |
| 4403     | 主账户信息查询   |
| 4405     | 存款子户列表查询 |
| 4410     | 存款账单查询     |
| 4420     | 冻结查询         |
| 4421     | 冻结明细查询     |

### 8.其他查询

**接口**

| flowtran | desc             |
| -------- | ---------------- |
| 4201     | 法院查询账户信息 |







----分割线---

## DpPublic

### 余额信息

- **DpBalanceCalculateOut**

  - **acct_bal**：账户余额

    > 1. 直接取dpa_sub_account的**acct_bal**，
    >
    > 2. 特殊场景(不常见)：存入金额时同时冻结，则：**账户余额需要包括本次冻结前存入的金额:，因为在一个事务中调用冻结检查时此时存入动作可能还没发生**。即：
    >    **acct_bal = acct_bal + froze_before_save_amt**

  - **hold_amt**：止付金额

    > froze_source= E 外部来源，即：冻结金额

  - **froze_amt**：冻结金额，只包括金额冻结的值

    > froze_source= I 内部来源，即：止付金额

  - **fact_froze_amt**：实际冻结金额

    > 冻结金额+止付金额
  - **self_usable_bal**：自身可用余额，不包含资金池额度

    > - **自身可用余额 = 账户余额 - 实际冻结余额**
    >   usable_bal = acct_bal - fact_froze_bal
    >
    > - 支取类型不是强行扣划和销户时，可用余额还应减去最小留存金额，其中实际冻结金额可以抵扣最小保留金额：
    >
    >   **自身可用余额 = 账户余额 -  实际冻结余额 与 最小留存金额中大的一个**
    >
    >   usable_bal = acct_bal - max( fact_froze_bal, min_remain_bal)
    >
    >   **usable_bal = acct_bal - (( fact_froze_bal > min_remain_bal ) ? fact_froze_bal :min_remain_bal)**

  - **usable_bal**：可用余额，包含资金池额度

    > - **可用余额 = 自身可用余额 + 资金池**
  >
    >   资金池 与协议相关，包括：透支协议额度 + 保护协议额度，保护协议一般是同客户下不同账户，就好比A卡没钱了可以在B卡中借过来。

  - **min_remain_bal**：最小留存金额

    > 直接取dpa_sub_account的**min_remain_bal**，若null则0

  - **whole_frozen_ind**：全额冻结标志

  - **whole_hold_ind**：全额止付标志


```java
if ( froze_type == 金额 ){
    
}
else 全额冻结 {
    if 外部 then 全额冻结
    if 内部 then 全额止付
}
```





--------一条随意的分隔线------

## Dp11

> 定期到期转存(续存)

### 数据源

​	dpa_sub_account

### 主体步骤

#### 1. 获取续存金额

##### **1.1 本金转存**

续存金额 = 账户余额

利息转入收息账户

##### 1.2 本息转存

续存金额 = 账户余额 + 待支付利息- 利息税（待扣增值税+待扣利息税）

##### 1.3 减少本金转存

续存金额 = 账户余额 + 待支付利息- 利息税（待扣增值税+待扣利息税）- renew_save_amt（**减去的金额**）

##### 1.4 添加金额转存

续存金额 = 账户余额 + 待支付利息- 利息税（待扣增值税+待扣利息税）+ renew_save_amt（**增加的金额**）

##### 1.5 **转入其他账号**

- 批量时，续存不检查冻结

  续存金额 = 账户余额 + 待支付利息- 利息税（待扣增值税+待扣利息税）

- 联机

  暂不讨论

#### 2. 检查续存合法性

> 简单来说，类似做开户时的检查，因为续存等价于再次开户。包括：存款产品检查、账户与产品的适配性、开户控制

#### 3. 转账处理

> 本金转存，利息入收息账户，本金不动；
> 本息转存，利息入自身账户，本金不动；
> 减少本金转存，利息入自身账户，需减去本金入指定账户；
> 添加本金转存，利息入自身账户，指定账户转钱到当前账户；
>
> 转入其他账户，利息和本金转入其他账户，销户；

##### 3.1 本金转存

> 只需处理利息，因为本金还是保留在原先账户上。只需将**待支取利息转入收息账户**

- **待支付利息记账**

  - 应付利息登记会计事件tas_accounting_event

    ```sql
    select * from tas_accounting_event where 
    accounting_alias = subAcct.getAccounting_alias() AND -- 应付利息账户别名
    accounting_subject='1'(E_ACCOUNTINGSUBJECT.DEPOSIT) AND -- 会计主体
    debit_credit='D' AND -- 借贷方向(借 应付利息)
    bal_attributes='DP02'; -- 余额属性，待支付利息
     -- 借贷方向说明(银行角度)：
     对于“银行”来说，应付利息是“负债”，即：应付利息进了收息账户
     借 应付利息
     	贷 收息账户存款
    ```

  - 利息税登记会计事件

    ```sql
    select * from tas_accounting_event where 
    accounting_alias = subAcct.getAccounting_alias() AND -- 应收税款账户别名
    accounting_subject='1'(E_ACCOUNTINGSUBJECT.DEPOSIT) AND -- 会计主体
    debit_credit='C' AND -- 借贷方向(贷 应收税款)
    bal_attributes='DP03'; -- 余额属性，利息税
     -- 借贷方向说明(银行角度)：
     对于“银行”来说，应收税款是“资产”，即：从账户存款中扣掉应收税款
     借 客户存款
     	贷 应收税款
    ```

- **利息入账**

  > 利息转入收息账户

  - 入利息

    1. 更新收息账户余额

    2. 登记账单表

    3. 登记会计事件

       ```sql
       select * from tas_accounting_event where 
       accounting_alias = subAcct.getAccounting_alias() AND -- 入息账户别名
       accounting_subject='1'(E_ACCOUNTINGSUBJECT.DEPOSIT) AND -- 会计主体
       debit_credit='C' AND -- 借贷方向(贷 收息账户存款。对应上面的应付利息)
       bal_attributes='DP01'; -- 余额属性，本金
       ```

  - 扣利息税

    1. 更新收息账户余额

    2. 登记账单表

    3. 登记会计事件

       ```sql
       select * from tas_accounting_event where 
       accounting_alias = subAcct.getAccounting_alias() AND -- 入息账户别名
       accounting_subject='1'(E_ACCOUNTINGSUBJECT.DEPOSIT) AND -- 会计主体
       debit_credit='D' AND -- 借贷方向(借 客户存款。对应上面的应收税款)
       bal_attributes='DP01'; -- 余额属性，本金
       ```

##### 3.2 本息转存

> 本息转存，与本金转存极类似。本金还是不动，只是利息是转入自身账户

- **待支付利息记账**

  同“本金转存”

- **利息入账**

  同”本金转存“，区别在于入自身账户而已

##### 3.3 减少本金转存

> 利息入自身账户（同上，略），需减去的本金转出

- 利息记账，利息入账（同上，略）
- （先借后贷）当前账户定期金额取出，转入prin_trsf_acct（本金转入账户，本金转出来到的账户）

##### 3.4 添加金额转存

> 利息入自身账户（同上，略），添加本金转入

- 利息记账，利息入账（同上，略）
- （先借后贷）prin_trsf_acct取出，转入当前账户（本金转入账户，转出钱到本金的账户）

##### 3.5 转入其他账号

- 利息入收息账户
- 本金转入其他账户
- 销户

#### 4. 重置账户信息

#### 5. 登记转存信息