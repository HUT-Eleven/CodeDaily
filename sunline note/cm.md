---
typora-copy-images-to: ../pictures
typora-root-url: ../pictures
---

# 利率

## cm2500

> 利率定义列表查询

查：cmp_inrt_code

## cm2501

> 利率详细信息查询

1. 先查cmp_inrt_code

2. 根据不同的Inrt_code_direction，查不同的表。

   2.1 参考利率：查基准利率表cmp_base_inrt

   2.2 简单利率：

   ​	1） 先查cmp_simple_inrt；

   ​	2） 再根据利率来源(录入I / 参考基准利率 R): 录入的直接取录入的，只有是参考基准利率时才去计算利率浮动，并且之后把对应的基准利率放入List01中。

   2.3 分层利率：

   ​	1） 先查cmp_tier_inrt；

   ​	2） 再，同上2.2 中的2) 根据利率来源..........

3. 最后查利率优惠信息cmp_inrt_promo！

## cm2502！

> 利率试算

1. 加数据到缓冲区

2. 根据日期获取有效的利率：**CmInrtQuery.qryEffeInrtByDate**

   2.1 利率指向== 参考利率：直接从cmp_base_inrt获取

   

   2.2 利率指向== 简单利率：

   ​	1）查cmp_simple_inrt（根据：利率编号、存期、币种、有效期....可以确定）；

   ​	2）再根据利率来源(录入I / 参考基准利率 R): 录入的直接取录入的，只有是参考基准利率时才去计算利率浮动;

   ​	3) 再获取利率优惠信息：如果有多条，**默认取最大优惠**，然后在原先的利率基础上加上（是加不是减：这个利率是给到客户，加上后利率变高，客户的利息自然就越高。）

   <img src="/image-20210306211512475.png" alt="image-20210306211512475" style="zoom: 67%;" />

   2.3 利率指向== 分层利率：

   ​	1）获取分层利率：

   ​		1.1）金额分层：根据金额+靠档方式 + 分层方式(超额/全额)即可确定利率；

   ​		1.2）存期分层：根据存期+靠档方式 + 分层方式(超额/全额)即可确定利率（其实和金额分层差不多，只是换个指标）；

   ​		1.3）金额+存期分层：先根据存期靠档再金额靠档 + 分层方式(超额/全额)即可确定利率；

   ```markdown
   备注：
   超额与全额：全额时，在该方法中需要定位到哪个利率，但超额时，需返回全部的利率信息，因为每一层次的利率信息都会用到。由外部根据匹配不同层级来计算利息。
   ```

   ​	2）再根据利率来源(录入I / 参考基准利率 R): 录入的直接取录入的，只有是参考基准利率时才去计算利率浮动;

   ​	3) 再获取利率优惠信息：如果有多条，**默认取最大优惠**，然后在原先的利率基础上加上（是加不是减：这个利率是给到客户，加上后利率变高，客户的利息自然就越高。）

3. 根据不同利率类型转换输出信息

   <img src="/image-20210306212023208.png" alt="image-20210306212023208" style="zoom:67%;" />

   <img src="/image-20210306212235610.png" alt="image-20210306212235610" style="zoom:67%;" />

   <img src="/image-20210306212734201.png" alt="image-20210306212734201" style="zoom:67%;" />

## cm2503

> 利率优惠定义列表查询

查：cmp_inrt_promo



























# 费用

## 一. 收费方式

   1.手工收费：柜面提供手工收费交易，选择收费编号后，根据收费条件自动进行收费试算。提交后进行收费记账处理。

   2.场景收费（自动收费、交易中弹窗收费）：交易中调用自动收费试算，数据保存到公共运行区。等到交易后调点，进行收费记账处理。

   3.批量收费：收取欠费金额

## 二. 收费参数表

### 	1. cmp_chrg_code

收费编码定义 ，针对不同的业务场景和使用规则，创建出一种费用种类，系统使用费用编号进行唯一标识

| 要素             | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| 收费编码         | 唯一标识(由数字和字母组成)                                   |
| 计费优惠策略     | 孰低（L）、孰高(H)；存在利率优惠时需要配置                   |
| 牌价种类         | 买卖价(B)、中间价(M),用于跨币种收费                          |
| 收费方式         | 1-online 2-batch                                             |
| 余额不足处理方式 | A-拒绝交易（终止交易)B-全部免收（不收取费用）C-部分免收（只收取余额，其余部分免收）D-全额欠费（费用金额全部转欠费）E-部分欠费（收取余额，其余部分转欠费） |
| 收费参考日期     | 根据欠费收取周期单位，标记特殊的收费日期；比如每周几、是否月末以及指定日期收费等等 |
| 费用机构来源     | 1-账户机构 2-交易机构 3-指定机构                             |
| 费用机构         | 当费用机构来源为指定机构（3）时，必输                        |
| 费用核算别名     | 用于费用账务处理，登记会计事件                               |
| 摊销核算别名     | 用于费用摊销账务处理，不填入表示不需要摊销                   |

###  2. cmp_chrg_code_form

**收费编码/收费公式/规则引擎** 三者的绑定，其中还有交易场景事件

| 要素     | 描述                                     |
| -------- | ---------------------------------------- |
| 收费编码 | 收费编码表中定义的收费编号               |
| 交易事件 | 业务会有相应的交易时间，在这里和收费绑定 |
| 规则引擎 | 如果收费需要达到木些条件时，才会触发收费 |
| 收费公式 | 收费公式表中定义的收费公式               |
| 生效时间 | 生效日期                                 |
| 失效日期 | 失效日期                                 |

### 3. cmp_chrg_form

收费公式的定义 ，费用公式用于配置某项费用需要按哪种方式计费，累计分层等方式；

| 要素                 | 描述                                                         |
| -------------------- | ------------------------------------------------------------ |
| 收费公式id           | 唯一性                                                       |
| 费用公式类型         | 1- 计费公式 （费用定价公式）；2 -优惠公式 （费用优惠公式）   |
| 计费分层标志         | Y-分层 N-简单                                                |
| 收费层次             | A-当次金额（本次交易金额）B-累计次数（累计的收费次数）C-累计金额（累计的交易金额）        D-累计金额+累计次数 |
| 分层计算方式         | A-全额累进、B-超额累进                                       |
| 费用累计对象类型     | A-账户（以账户为维度累计收费次数和交易金额）C-客户（以客户为维度累计收费次数和交易金额） |
| 费用累计区分场景标志 | Y-按费用编号+计费场景统计数据N-按费用代码统计数据            |
| 费用累计周期         | D-日、M-月、Q-季、Y-年                                       |
|                      |                                                              |

### 4. cmp_chrg_form_details

  收费公式明细表：描述按什么方式收费，收多少费等信息。

| 要素       | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| 费用公式   | 收费公式定义表里定义的                                       |
| 费用币种   | 费用金额对应的币种                                           |
| 顺序号     | 代表一组分层次数和分层金额；费用公式编号、货币代码以及顺序号 必须唯一； |
| 分层次数   | 以累计次数为维度，配置次数层次;默认向下靠档，包含边界值      |
| 分层金额   | 以当次金额或累计金额为维度，配置金额层次默认向下靠档，包含边界值； |
| 计费方式   | 1-percent：金额比例<br />2-price ：单价<br />3-fixed amount ：固定金额<br />4-trxn amount multiply percent：交易金额x比例<br />5-fixed amount add percent ：固定金额+交易金额x百分比 |
| 费用金额   | 当费用计算方式为“单价”、“固定金额”以及“固定金额+比例”时，需要填入数值 |
| 费用比例   | 当费用计算方式为“比例”和“交易金额*比例” 时，需要填入数值     |
| 费用最小值 | 计费金额必须大于等于最小值，超限则取最小值；                 |
| 费用最大值 | 计费金额必须小于等于最大值，超限则取最大值；                 |

##  三. 收费配置演示

业务中，我们常常根据指定的业务场景，配置相关收费，基本步骤如下：

1.费用编码定义（表 cmp_chrg_code）

![img](/wps5.jpg)

2.绑定交易事件和收费公式（表 cmp_chrg_code_form）

![img](/wps6.jpg)

3.收费公式定义（表cmp_chrg_form）

![img](/wps7.jpg)

4.收费公式明细（表cmp_chrg_form_details）

![img](/wps8.jpg)

上面是一个简单的收费配置，当然，我们的收费远不止这么简单，还有费用摊销，费用浮动，费用优惠，费用分润，退还，分层收费等功能.

## 四. 接口

### cm2700

> 业务流程中大致的表关系：先获取**cmp_chrg_code**，再获取**cmp_chrg_code_form**，根据**cmp_chrg_code_form**中的规则ID进行筛选。之后开始计算费用金额：先获取**cmp_chrg_form**，再根据**cmp_chrg_form_details**进行计费。

1. 检查

2. 查询费用编号定义- **cmp_chrg_code**

3. 费用试算

   3.1 检查

   3.2 匹配有效的收费信息List（**注：**此处代码可优化，如果没获取有效的收费信息，判断处理完之后应该直接return）

   ​	3.2.1 添加数据集

   ​	3.2.2 查询有效的费用编号 - CmChrgDao.selEffeChrgCodeList ---> List<**cmp_chrg_code**>  

   ​			（**注：**此处基本上可能只会获取到**一条数据**，因为cmp_chrg_code的主键是org_id和chrg_code，sql传入了chrg_code。其他	场景可以会不传chrg_code，根据trxn_event_id来匹配费用）

   ​	3.2.3 循环 List<cmp_chrg_code>，根据**规则chrg_cond_code**匹配有效的 “费用编号与公式关联表” - **cmp_chrg_code_form**，并返回

   3.3 循环收费信息List，计算费用总和

   ​	3.3.1 确定计费币种

   ​			优先取：费用公式明细表cmp_chrg_form_details中的ccy_code

   ​			其次取：cmp_chrg_code中的计费币种calc_chrg_ccy

   ​	3.3.2 计算费用金额 	CmChrgCalc.calcChrgAmt

   ​			3.3.2.1 如果交易金额不为空，则进行币种兑换：交易币种  转为 计费币种。e.g. 交易金额是$100,但计费币种是￥,则需要把交易金额改为￥

   ​			3.3.2.2 基础费额计算

   ​				3.3.2.2.1 获取费用公式**cmp_chrg_form**，根据**chrg_calc_tier_ind**判断是否分层。

   ​				3.3.2.2.2 不分层

   ​						3.3.2.2.2.1 获取费用公式明细数据**cmp_chrg_form_details**

   ​						3.3.2.2.2.2 根据计算方式计算费用，根据cmp_chrg_form_details中’**chrg_calc_method**‘

   - **PRICE - 单价 - 2**

     则外部必须传入数量

     基础费额 = 数量 * 单价

   - **AMOUNT - 固定金额 - 3**

     基础费额 = 固定金额

   - **PERCENT - 百分比 - 1**

     基础费额 = 金额 * 比例 / 100  （注：数据库中数值不包含%，所以代码中记得除以100）

   - **TRXN_AMT_PERCENT - 交易金额*百分比 - 4**

     基础费额 = 金额 * 比例 / 100

   - **AMOUNT_ADD_PERCENT - 固定金额+百分比 - 5**

     基础费额 = 固定金额+（交易金额 * 比例）

   - 最后是：基础费额边界值检查

     cmp_chrg_form_details中的chrg_min_value/chrg_max_value，超过了取最大值，小于取最小值.
     
     ​		3.3.2.2.3 分层
     
     ​		分层比较复杂，。。。
     
     ​	3.3.2.3 计算浮动和优惠额
     
     ​		3.3.2.3.1 浮动费额计算
     
     ​		3.3.2.3.2 优惠费额计算
     
     ​	3.3.2.4 最终费用金额 = 基础费额 + 浮动费额-优惠金额
     
     ​	3.3.2.5 输出
     
     3.3.3 组织收费信息，输出
     
     
